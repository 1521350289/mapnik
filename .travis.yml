language: cpp

compiler:
 - clang
# - gcc

env:
  matrix:
   - DEBUG=True ENABLE_LOG=True DEFAULT_LOG_SEVERITY=debug XMLPARSER="libxml2" DEMO=False BENCHMARK=False CUSTOM_CXXFLAGS="" CUSTOM_LDFLAGS=""
   - DEBUG=False ENABLE_LOG=False DEFAULT_LOG_SEVERITY=none XMLPARSER="ptree" DEMO=False BENCHMARK=False CUSTOM_CXXFLAGS="" CUSTOM_LDFLAGS=""

before_install:
 - nproc
 - free
 # we need at least g++-4.7 for c++11 features
 - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
 # clear out travis postgis
 - sudo mv /etc/apt/sources.list.d/pgdg-source.list* /tmp
 - sudo apt-get -qq remove postgis
 # grab more recent gdal/proj
 - sudo add-apt-repository -y ppa:ubuntugis/ubuntugis-unstable
 # more recent boost
 - sudo add-apt-repository -y ppa:boost-latest/ppa
 - sudo apt-get update -y
 - sudo apt-get install -y ttf-wqy-microhei postgis postgresql-9.1-postgis-2.1 postgresql-9.1-postgis-2.1-scripts libgdal1-dev libstdc++6 libstdc++-4.8-dev make boost1.55 python-nose libicu-dev libpng-dev libjpeg-dev libtiff-dev libwebp-dev libz-dev libfreetype6-dev libxml2-dev libproj-dev libcairo-dev python-cairo-dev libsqlite3-dev
 - createdb -EUTF8 template_postgis -U postgres
 - psql -c 'create extension postgis' template_postgis  -U postgres
 - if [[ "${CXX}" == 'g++' ]]; then sudo apt-get install gcc-4.8 g++-4.8; export CXX="$(which g++-4.8)"; export CC="$(which gcc-4.8)"; fi;
 - if [[ "${CXX}" == 'clang++' ]]; then export CXX="$(which clang++)"; export CC="$(which clang)"; fi;
 - wget http://www.freedesktop.org/software/harfbuzz/release/harfbuzz-0.9.34.tar.bz2
 - tar xf harfbuzz-0.9.34.tar.bz2
 - cd harfbuzz-0.9.34
 - ./configure --prefix=/usr --with-icu --with-cairo=no --with-glib=no --with-gobject=no --with-graphite2=no --with-freetype --with-uniscribe=no --with-coretext=no && make && sudo make install
 - cd ../

install:
 - ./configure CXX="${CXX}" CC="${CC}" CUSTOM_CXXFLAGS="${CUSTOM_CXXFLAGS}" CUSTOM_LDFLAGS="${CUSTOM_LDFLAGS}" XML_PARSER="${XML_PARSER}" ENABLE_LOG="${ENABLE_LOG}" DEBUG="${DEBUG}" DEMO="${DEMO}" BENCHMARK="${BENCHMARK}" CPP_TESTS=True CAIRO=True FAST=True || cat config.log
 - if [[ "${CXX}" == 'g++-4.8' ]]; then JOBS=2 make; else JOBS=4 make; fi;

before_script:
 - make test

script:
 - if [[ ${BENCHMARK} != False ]]; then make bench; fi;
